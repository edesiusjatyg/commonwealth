# Update Log v0.4.1

**Release Date**: 2025-01-XX  
**Author**: Development Team

---

## Overview

Version 0.4.1 focuses on cache schema fixes, database management tooling, and full support for all five timeframes. This release ensures the cache system is robust, properly tracks access times, and provides debugging capabilities.

---

## Changes

### 1. Cache Schema Fix

**Issue**: The `search_cache` table was missing the `last_accessed` column, which prevented proper TTL cleanup for 7d, 15d, and 30d timeframes.

**Fix**:
- Added `last_accessed TIMESTAMP DEFAULT CURRENT_TIMESTAMP` to `search_cache` table schema
- Updated `get_search_cache()` method to update `last_accessed` timestamp on cache hits
- Ensures both `search_cache` and `sentiment_cache` tables now track access times consistently

**Impact**: Cache cleanup now works correctly for all timeframes.

---

### 2. Full Timeframe Support

**Added**: Complete TTL logic for all 5 timeframes:

| Timeframe | TTL Rule | Description |
|-----------|----------|-------------|
| `1d` | Date change | Deleted immediately when date changes |
| `3d` | Date change | Deleted immediately when date changes |
| `7d` | +1 day tolerance | Kept for 1 day after last access |
| `15d` | +3 days tolerance | Kept for 3 days after last access |
| `30d` | +5 days tolerance | Kept for 5 days after last access |

**Implementation**:
- Updated `cleanup_old_cache()` method to handle all 5 timeframes
- Added cleanup rules for `1d` and `7d` timeframes
- Maintains existing rules for `3d`, `15d`, and `30d`

---

### 3. Database Query Script

**Added**: `query_cache.sh` - A bash script for inspecting the SQLite cache database.

**Features**:
- Shows all records in `search_cache` and `sentiment_cache` tables
- Displays record counts and statistics
- Shows text/summary lengths instead of full content for readability
- Ordered by `last_accessed` DESC for easy debugging
- Added to `.gitignore` (development-only tool)

**Usage**:
```bash
./query_cache.sh              # Uses default cache.db
./query_cache.sh custom.db    # Uses custom database file
```

---

### 4. Cleanup

**Removed**:
- `MIGRATION_SUMMARY.md` - Legacy migration documentation
- `PROJECT_SUMMARY.md` - Outdated project summary

**Updated**:
- `.gitignore` - Added `query_cache.sh` to excluded files

---

## Technical Details

### Cache Manager Updates

**File**: `services/cache_manager.py`

1. **Schema Change**:
   ```python
   CREATE TABLE IF NOT EXISTS search_cache (
       # ... existing fields ...
       last_accessed TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  # NEW
       # ...
   )
   ```

2. **Access Tracking**:
   ```python
   def get_search_cache(...):
       # ... fetch logic ...
       if result:
           cursor.execute("""
               UPDATE search_cache 
               SET last_accessed = CURRENT_TIMESTAMP
               WHERE token = ? AND timeframe = ? AND query_date = ?
           """, ...)
   ```

3. **TTL Cleanup**:
   - Added 1d and 7d cleanup rules
   - All 5 timeframes now have proper TTL logic
   - Cleanup runs on cache manager initialization

---

## Migration Notes

**Database Schema Migration**:

If you have an existing `cache.db` file without the `last_accessed` column in `search_cache`, you have two options:

1. **Delete and recreate** (simplest):
   ```bash
   rm cache.db
   # Restart the service - tables will be recreated automatically
   ```

2. **Manual migration** (preserves data):
   ```sql
   ALTER TABLE search_cache ADD COLUMN last_accessed TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
   UPDATE search_cache SET last_accessed = created_at;
   ```

---

## Testing

**Cache System**:
1. Test all 5 timeframes (1d, 3d, 7d, 15d, 30d)
2. Verify cache hits update `last_accessed` timestamp
3. Verify TTL cleanup works correctly for each timeframe
4. Verify query limits (10 per token/timeframe/day)

**Database Script**:
1. Run `./query_cache.sh` to inspect cache contents
2. Verify output shows all records with proper formatting
3. Verify statistics are accurate

---

## Files Modified

- `services/cache_manager.py` - Fixed schema, added 1d/7d TTL, access tracking
- `.gitignore` - Added query_cache.sh

## Files Created

- `query_cache.sh` - New database inspection script

## Files Removed

- `MIGRATION_SUMMARY.md`
- `PROJECT_SUMMARY.md`

---

## Known Issues

None.

---

## Next Steps

- Monitor cache performance in production
- Consider adding cache size limits
- Consider adding metrics/monitoring endpoints
