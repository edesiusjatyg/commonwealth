# V0.3 - Tool Integration & LangSearch Sources

## Date: January 10, 2026

## Problem Analysis

User reported that the chatbot service was returning error fallbacks for queries like "What is the difference between PoW and PoS?" and that LangSearch sources were not appearing in the response JSON.

### Root Causes Identified

1. **Gemini API Quota Exhausted**: The primary issue was that the API key had exceeded its free-tier quota for `gemini-2.0-flash-exp` model
   - Error: `429 RESOURCE_EXHAUSTED`
   - Quota limits: 0 for free tier input tokens and requests
   
2. **Tool Integration Missing**: The chatbot was using structured JSON output but was NOT actually invoking the LangSearch tool when needed
   - Tools were defined but never called
   - No two-pass system to check if tools were needed and execute them

3. **LangSearch API Endpoint Wrong**: The news_search tool was calling the wrong endpoint
   - Was using: `/v1/search`
   - Should be: `/v1/web-search`
   - Response format parsing was also incorrect

## Changes Implemented

### 1. Tool Calling System (Two-Pass Approach)

**File**: `app/agents/gemini_client.py`
- Split into two methods:
  - `generate_with_tools()`: Pass 1 - Check if tools are needed using function calling
  - `generate_structured()`: Pass 2 - Generate final structured JSON response
- Added proper function declaration support for Gemini 2.0

**File**: `app/services/agent_service.py`
- Implemented two-pass workflow:
  1. First call Gemini with tool definitions to check if tool is needed
  2. If tool requested, execute it (e.g., LangSearch API)
  3. Add tool results to context
  4. Second call to Gemini to generate final structured response with tool results
- Extract sources from tool results (news articles) and merge them into the response

**File**: `app/agents/tool_registry.py`
- Added `get_all_tool_definitions()` method to return tool definitions for function calling
- Added auto-registration of default tools (NewsSearchTool) in `__init__`
- Tools are now automatically available without manual registration

### 2. LangSearch Integration Fix

**File**: `app/tools/news_search.py`
- Fixed API endpoint: Changed from `/v1/search` to `/v1/web-search`
- Updated response parsing to match actual LangSearch format:
  - Path: `data.webPages.value[]` (not `results[]`)
  - Fields: `name` (not `title`), `url`, `summary`, `snippet`
- Extract domain from URL as source name
- Proper error handling and URL validation

### 3. Error Logging Enhancements

**File**: `app/services/chat_service.py`
- Added detailed error logging with error type
- Include first 100 chars of error in user-facing message for debugging
- Full stack trace in logs for troubleshooting

### 4. Prompt Updates

**File**: `app/services/prompt_builder.py`
- Added explicit instructions for when to use tools:
  - "If user asks about 'news', 'latest updates', 'recent events': USE the news_search tool"
- Clarified that tool results should be incorporated into explanations
- Sources should come from actual tool results when available

### 5. Model Selection

**File**: `app/agents/gemini_client.py`
- Using `gemini-2.5-flash` (latest stable model)
- Supports function calling needed for tool integration
- Free tier has 20 requests per day limit

## Architecture: Two-Pass System

```
User Query: "What are the latest news about Bitcoin ETF?"
                ↓
        [Pass 1: Tool Detection]
                ↓
    Gemini + Tool Definitions
                ↓
        Decision: Call news_search?
                ↓
            YES → Execute LangSearch API
                ↓
    Fetch actual news articles with URLs
                ↓
        [Pass 2: Final Response]
                ↓
    Gemini + Tool Results + Structured Output
                ↓
    ChatData JSON with:
    - explanation: (includes news info)
    - sources: [{type: "external", url: "..."}]
    - chart_config: {...}
    - suggested_prompts: [...]
```

## Expected Output Format (with LangSearch)

```json
{
  "data": {
    "explanation": "Recent news shows SEC approved Bitcoin ETF...",
    "sources": [
      {
        "type": "external",
        "name": "morningstar.es",
        "url": "https://www.morningstar.es/..."
      },
      {
        "type": "external",
        "name": "epe.es",
        "url": "https://www.epe.es/..."
      }
    ],
    "chart_config": {
      "coins": ["BTC"],
      "type": "single_chart",
      "timeframe": "7d"
    },
    "suggested_prompts": [...]
  },
  "meta": {...}
}
```

## Testing Notes

1. **API Quota Issue**: The original error was NOT a code bug - it was an API quota limit
   - Free tier limits are very restrictive
   - Need to monitor quota usage: https://ai.dev/rate-limit
   
2. **Tool Integration**: Now properly implemented
   - Tools are defined and registered automatically
   - Two-pass system ensures tools are called when needed
   - Tool results (including URLs) are merged into final response

3. **LangSearch**: Correctly configured
   - Using `/v1/web-search` endpoint
   - Parsing `data.webPages.value[]` array
   - Extracting URLs, titles, summaries from articles

## Next Steps

1. Test with actual queries once API quota resets or with a paid API key
2. Verify LangSearch sources appear in responses for news queries
3. Consider adding more tools (e.g., price lookup, blockchain explorer)
4. Add retry logic for rate-limited requests
5. Monitor and log tool usage for analytics

## Files Modified

- `app/agents/gemini_client.py` - Added two-pass generation methods
- `app/services/agent_service.py` - Implemented tool calling workflow
- `app/agents/tool_registry.py` - Added auto-registration and get_all_tool_definitions()
- `app/tools/news_search.py` - Fixed LangSearch API endpoint and response parsing
- `app/services/chat_service.py` - Enhanced error logging
- `app/services/prompt_builder.py` - Added tool usage instructions

## Key Learnings

1. **API Quotas Matter**: Always check API quotas first when getting mysterious errors
2. **Function Calling ≠ Structured Output**: Can't use both simultaneously - need two-pass approach
3. **Tool Results Must Be Merged**: Sources from tools won't appear unless explicitly added to response
4. **Error Messages Are Gold**: The detailed error messages revealed the exact issue (quota exhausted)
